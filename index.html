<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Where is Shubhang?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 28px;
            margin: 20px 0 30px;
            text-align: center;
            color: #00d9ff;
        }

        .input-row {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 15px;
        }

        input {
            flex: 1;
            padding: 12px;
            border: 2px solid #16213e;
            border-radius: 10px;
            background: #0f3460;
            color: #eee;
            font-size: 16px;
        }

        input::placeholder {
            color: #888;
        }

        button {
            width: 100%;
            max-width: 400px;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #00d9ff;
            color: #1a1a2e;
        }

        .btn-secondary {
            background: #533483;
            color: #eee;
        }

        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 30px auto;
        }

        .compass {
            width: 100%;
            height: 100%;
            border: 4px solid #00d9ff;
            border-radius: 50%;
            position: relative;
            background: radial-gradient(circle, #0f3460 0%, #16213e 100%);
        }

        .compass-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: #00d9ff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 120px;
            background: linear-gradient(to bottom, #ff4444 0%, #ff4444 50%, transparent 50%);
            transform-origin: center bottom;
            transform: translate(-50%, -100%) rotate(0deg);
            transition: transform 0.3s ease-out;
            z-index: 5;
        }

        .needle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 15px solid #ff4444;
        }

        .caricature {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #00d9ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: left 0.3s ease-out, top 0.3s ease-out;
            z-index: 15;
        }

        .caricature img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            25% { transform: translate(-50%, -50%) translateX(-5px); }
            75% { transform: translate(-50%, -50%) translateX(5px); }
        }

        .caricature.shake {
            animation: shake 0.2s ease-in-out infinite;
        }

        .hint {
            text-align: center;
            max-width: 400px;
            margin: 10px auto;
            font-size: 14px;
            color: #aaa;
            line-height: 1.5;
        }

        .status {
            background: #0f3460;
            border-radius: 10px;
            padding: 15px;
            max-width: 400px;
            width: 100%;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .status-label {
            color: #888;
        }

        .status-value {
            color: #00d9ff;
            font-weight: 600;
        }

        .message {
            background: #533483;
            color: #eee;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            max-width: 400px;
            font-size: 14px;
        }

        .message.error {
            background: #d9534f;
        }

        .message.success {
            background: #5cb85c;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #5cb85c;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .compass-label {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: #00d9ff;
        }

        .north {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .south {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .east {
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .west {
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <h1>Where is Shubhang?</h1>

    <div class="input-row">
        <input type="number" id="latInput" placeholder="Latitude" step="any">
        <input type="number" id="lngInput" placeholder="Longitude" step="any">
    </div>

    <button class="btn-primary" id="navigateBtn">Navigate</button>
    <button class="btn-secondary" id="recalibrateBtn">Recalibrate Compass</button>

    <div id="messageContainer"></div>

    <div class="compass-container">
        <div class="compass">
            <div class="compass-label north">N</div>
            <div class="compass-label south">S</div>
            <div class="compass-label east">E</div>
            <div class="compass-label west">W</div>
            <div class="needle" id="needle"></div>
            <div class="compass-center"></div>
            <div class="caricature" id="caricature">
                <img src="caricature.png" onerror="this.style.display='none'; this.parentElement.innerHTML='ðŸ™‚';" alt="Shubhang">
            </div>
        </div>
    </div>

    <p class="hint">Walk where the needle points. If Shubhang shakes, you're going the wrong way.</p>

    <div class="status">
        <div class="status-item">
            <span class="status-label">Current Heading:</span>
            <span class="status-value" id="headingValue">--Â°</span>
        </div>
        <div class="status-item">
            <span class="status-label">Target Bearing:</span>
            <span class="status-value" id="bearingValue">--Â°</span>
        </div>
        <div class="status-item">
            <span class="status-label">Distance:</span>
            <span class="status-value" id="distanceValue">--m</span>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // App state
        let targetLat = null;
        let targetLng = null;
        let userLat = null;
        let userLng = null;
        let smoothHeading = 0;
        let targetBearing = 0;
        let isNavigating = false;
        let watchId = null;
        let compassSupported = false;

        // DOM elements
        const latInput = document.getElementById('latInput');
        const lngInput = document.getElementById('lngInput');
        const navigateBtn = document.getElementById('navigateBtn');
        const recalibrateBtn = document.getElementById('recalibrateBtn');
        const needle = document.getElementById('needle');
        const caricature = document.getElementById('caricature');
        const headingValue = document.getElementById('headingValue');
        const bearingValue = document.getElementById('bearingValue');
        const distanceValue = document.getElementById('distanceValue');
        const messageContainer = document.getElementById('messageContainer');
        const toast = document.getElementById('toast');

        // Helper: Show message
        function showMessage(text, type = 'info') {
            messageContainer.innerHTML = '<div class="message ' + type + '">' + text + '</div>';
        }

        // Helper: Show toast
        function showToast(text) {
            toast.textContent = text;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }

        // Helper: Clear message
        function clearMessage() {
            messageContainer.innerHTML = '';
        }

        // Calculate distance using Haversine formula
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaPhi = (lat2 - lat1) * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Calculate bearing from point A to point B
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaLambda = (lon2 - lon1) * Math.PI / 180;

            const y = Math.sin(deltaLambda) * Math.cos(phi2);
            const x = Math.cos(phi1) * Math.sin(phi2) -
                      Math.sin(phi1) * Math.cos(phi2) * Math.cos(deltaLambda);
            
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        // Normalize angle to -180 to 180 range
        function normalizeAngle(angle) {
            while (angle > 180) angle -= 360;
            while (angle < -180) angle += 360;
            return angle;
        }

        // Update compass and caricature position
        function updateCompass() {
            if (!isNavigating || userLat === null || targetLat === null) return;

            targetBearing = calculateBearing(userLat, userLng, targetLat, targetLng);
            
            let relativeAngle = normalizeAngle(targetBearing - smoothHeading);

            needle.style.transform = 'translate(-50%, -100%) rotate(' + relativeAngle + 'deg)';

            const distance = haversineDistance(userLat, userLng, targetLat, targetLng);

            headingValue.textContent = Math.round(smoothHeading) + 'Â°';
            bearingValue.textContent = Math.round(targetBearing) + 'Â°';
            distanceValue.textContent = Math.round(distance) + 'm';

            const compassRadius = 150;
            const caricatureRadius = 25;
            const angleRad = (relativeAngle - 90) * Math.PI / 180;
            
            const x = compassRadius + (compassRadius - caricatureRadius) * Math.cos(angleRad);
            const y = compassRadius + (compassRadius - caricatureRadius) * Math.sin(angleRad);
            
            caricature.style.left = x + 'px';
            caricature.style.top = y + 'px';

            if (Math.abs(relativeAngle) > 90) {
                caricature.classList.add('shake');
            } else {
                caricature.classList.remove('shake');
            }
        }

        // Handle device orientation (compass)
        function handleOrientation(event) {
            let heading = null;

            if (event.webkitCompassHeading !== undefined) {
                heading = event.webkitCompassHeading;
            } else if (event.alpha !== null) {
                heading = 360 - event.alpha;
            }

            if (heading !== null) {
                smoothHeading = smoothHeading * 0.85 + heading * 0.15;
                updateCompass();
            }
        }

        // Handle GPS position update
        function handlePosition(position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;
            updateCompass();
        }

        // Handle GPS error
        function handlePositionError(error) {
            showMessage('Location access is required. Please enable location permissions.', 'error');
            stopNavigation();
        }

        // Start navigation
        function startNavigation() {
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);

            if (isNaN(lat) || isNaN(lng)) {
                showMessage('Please enter valid latitude and longitude', 'error');
                return;
            }

            if (lat < -90 || lat > 90) {
                showMessage('Latitude must be between -90 and 90', 'error');
                return;
            }

            if (lng < -180 || lng > 180) {
                showMessage('Longitude must be between -180 and 180', 'error');
                return;
            }

            targetLat = lat;
            targetLng = lng;
            isNavigating = true;

            showMessage('Navigating to: ' + lat.toFixed(6) + ', ' + lng.toFixed(6), 'success');
            setTimeout(clearMessage, 3000);

            // Request location permission and start tracking
            if (navigator.geolocation) {
                // First, try to get current position to trigger permission
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // Permission granted, now start watching
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        updateCompass();
                        
                        watchId = navigator.geolocation.watchPosition(
                            handlePosition,
                            handlePositionError,
                            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                        );
                    },
                    function(error) {
                        // Permission denied or error
                        showMessage('Location access is required. Please enable location permissions.', 'error');
                        console.error('Geolocation error:', error);
                        stopNavigation();
                        return;
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                showMessage('Geolocation is not supported by this device.', 'error');
                stopNavigation();
                return;
            }

            // Request compass permission
            if (compassSupported) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(function(permissionState) {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                            } else {
                                showMessage('Compass permission denied. Navigation will work without compass.', 'error');
                            }
                        })
                        .catch(function(err) {
                            console.error('Compass permission error:', err);
                        });
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            }

            navigateBtn.textContent = 'Stop Navigation';
            navigateBtn.classList.remove('btn-primary');
            navigateBtn.classList.add('btn-secondary');
        }

        // Stop navigation
        function stopNavigation() {
            isNavigating = false;

            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            window.removeEventListener('deviceorientation', handleOrientation);

            navigateBtn.textContent = 'Navigate';
            navigateBtn.classList.remove('btn-secondary');
            navigateBtn.classList.add('btn-primary');

            headingValue.textContent = '--Â°';
            bearingValue.textContent = '--Â°';
            distanceValue.textContent = '--m';
            
            caricature.classList.remove('shake');
        }

        // Recalibrate compass
        function recalibrateCompass() {
            smoothHeading = 0;
            showToast('Compass recalibrated');
        }

        // Event listeners
        navigateBtn.addEventListener('click', function() {
            if (isNavigating) {
                stopNavigation();
            } else {
                startNavigation();
            }
        });

        recalibrateBtn.addEventListener('click', recalibrateCompass);

        // Check compass support on load
        window.addEventListener('load', function() {
            if (window.DeviceOrientationEvent) {
                compassSupported = true;
            } else {
                showMessage('Compass not supported on this device.', 'error');
            }
        });
    </script>
</body>
</html>